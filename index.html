<!DOCTYPE html>
<html>

    <head>
    <title>custom</title>
    <meta charset="utf-8" />
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
         <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>

    </head>

    <body>
    <script>
AFRAME.registerComponent('unified-move-limited', {
  schema: {
    speed: {type: 'number', default: 3},
    minX: {type: 'number', default: -16},
    maxX: {type: 'number', default: 19},
    minZ: {type: 'number', default: -15},
    maxZ: {type: 'number', default: 5}
  },
  init: function () {
    this.keys = {};
    window.addEventListener('keydown', e => this.keys[e.code] = true);
    window.addEventListener('keyup', e => this.keys[e.code] = false);
    this.direction = new THREE.Vector3();
    this.velocity = new THREE.Vector3();
  },
  tick: function (time, deltaTime) {
    const dt = deltaTime / 1000;
    const camera = this.el.querySelector('[camera]');
    if (!camera) return;

    
    let inputX = 0;
    let inputY = 0;

    // WASD入力
    if (this.keys['KeyW']) inputY += 1;
    if (this.keys['KeyS']) inputY -= 1;
    if (this.keys['KeyA']) inputX -= 1;
    if (this.keys['KeyD']) inputX += 1;

    // スティック入力（VRコントローラー）
  const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
for (let i = 0; i < gamepads.length; i++) {
  const gp = gamepads[i];
  if (gp && gp.connected) {
    console.log("id:", gp.id, "axes:", gp.axes);

    // 右コントローラーを判定
    if (gp.id.toLowerCase().includes("right")) {
      // まず [2,3] を試す
      let rx = gp.axes[2] || 0;
      let ry = gp.axes[3] || 0;

      // もし [2,3] が常に 0 なら [0,1] を使う
      if (Math.abs(rx) < 0.01 && Math.abs(ry) < 0.01) {
        rx = gp.axes[0] || 0;
        ry = gp.axes[1] || 0;
      }

      inputX += rx;
      inputY += -ry;
      break;
    }
  }
}

    // 入力がなければ何もしない
    if (Math.abs(inputX) < 0.05 && Math.abs(inputY) < 0.05) return;

    
    const camObj = camera.object3D;
    const forward = new THREE.Vector3();
    camObj.getWorldDirection(forward);
    forward.y = 0;
    forward.normalize();

    const right = new THREE.Vector3().crossVectors(new THREE.Vector3(0, 1, 0), forward).normalize();

    const move = new THREE.Vector3();
    move.copy(forward).multiplyScalar(-inputY); // ← ここでWSの向きを修正！
    move.add(right.multiplyScalar(inputX));
    move.multiplyScalar(this.data.speed * dt);

    // --- 移動と制限 ---
    const pos = this.el.object3D.position;
    pos.add(move);
    pos.x = Math.max(this.data.minX, Math.min(this.data.maxX, pos.x));
    pos.z = Math.max(this.data.minZ, Math.min(this.data.maxZ, pos.z));
  }
});
</script>


<script>
AFRAME.registerComponent('no-cull', {
  init: function () {
    this.el.object3D.traverse(obj => {
      obj.frustumCulled = false;
    });
  }
});
</script>


<script>
function spawnInstant(parentEl, modelId, options) {
  const count = options.count || 10;
  const y = options.y || 0;
  const scale = options.scale || '1 1 1';

  // 全体範囲
  const minX = -40;
  const maxX = 40;
  const minZ = -30;
  const maxZ = 40;

  // 移動制限範囲（避けるZ軸）
  const avoidMinZ = -18;
  const avoidMaxZ = 7;

  for (let i = 0; i < count; i++) {
    let x, z;
    do {
      x = Math.random() * (maxX - minX) + minX;
      z = Math.random() * (maxZ - minZ) + minZ;
    } while (z >= avoidMinZ && z <= avoidMaxZ);

    const el = document.createElement('a-entity');
    el.setAttribute('gltf-model', modelId);
    el.setAttribute('position', `${x} ${y} ${z}`);
    el.setAttribute('scale', scale);   
    el.setAttribute('shadow', 'receive:true');
    el.setAttribute('animation-mixer', '');
    parentEl.appendChild(el);
  }
}

function spawnWithDelay(parentEl, modelId, options) {
  const count = options.count || 10;
  const y = options.y || 0;
  const scale = options.scale || '1 1 1';
  const delay = options.delay || 500;

  // 全体範囲
  const minX = -40;
  const maxX = 40;
  const minZ = -30;
  const maxZ = 40;

  // 移動制限範囲（避けるZ軸）
  const avoidMinZ = -18;
  const avoidMaxZ = 7;

  let spawned = 0;

  function spawnOne() {
    if (spawned >= count) return;

    let x, z;
    do {
      x = Math.random() * (maxX - minX) + minX;
      z = Math.random() * (maxZ - minZ) + minZ;
    } while (z >= avoidMinZ && z <= avoidMaxZ);

    const el = document.createElement('a-entity');
    el.setAttribute('gltf-model', modelId);
    el.setAttribute('position', `${x} ${y} ${z}`);
    el.setAttribute('scale', scale);  
    el.setAttribute('shadow', 'receive:true');
    el.setAttribute('animation-mixer', '');
    el.setAttribute('mesh-standard-material', 'side:double; transparent:true; opacity:1');
    if (modelId === '#angel') {
      el.setAttribute('sin-forward-loop', 'amplitude:0.5; speed:2; axis:y');
    }
    parentEl.appendChild(el);

    spawned++;
    if (spawned < count) {
      setTimeout(spawnOne, delay);
    }
  }

  spawnOne();
}

AFRAME.registerComponent('spawn-custom', {
  init: function () {
    // 海藻 → 一気に生成、Z制限なし、スケール大きめ
    spawnInstant(this.el, '#kaisou', {count: 50, y: -1, scale: '1 1 1', avoidZ: true});

    // 岩 → 一気に生成
    spawnInstant(this.el, '#iwa', {count: 10, y: 0, scale: '0.7 0.7 0.7', avoidZ: true});

    // クマノミ → ディレイ付き生成、Z制限あり
    spawnWithDelay(this.el, '#kumanomi', {count: 10, y: 2, scale: '0.3 0.3 0.3', delay: 1000, avoidZ: false});
spawnWithDelay(this.el, '#angel', {count: 10, y: 10, scale: '0.5 0.5 0.5', delay: 2000, avoidZ: false});
    // クラゲ → ディレイ付き生成、Z制限あり
    spawnWithDelay(this.el, '#kurage', {count: 4, y: 4, scale: '0.4 0.4 0.4', delay: 1500, avoidZ: false});
  }
});

</script>

<!-- 呼び出し -->



<script>
AFRAME.registerComponent('sin-forward-loop', {
    //上下の移動(エンゼルフィッシュに使用(z軸だけ)
  schema: {
    amplitude: {type: 'number', default: 0.5},   
    speed: {type: 'number', default: 2},         
    forwardSpeed: {type: 'number', default: 0.05}, 
    distance: {type: 'number', default: 20}      // 進む距離
  },
  init: function () {
    this.startPos = this.el.object3D.position.clone();
    this.direction = 1; // 1=前進, -1=戻り
  },
  tick: function (time, delta) {
    const t = time / 1000;
    const pos = this.el.object3D.position;

    // 上下にsin波
    pos.y = this.startPos.y + Math.sin(t * this.data.speed) * this.data.amplitude;

    // 前進・後退
    pos.z += this.direction * this.data.forwardSpeed * (delta / 16);

    // 判定：一定距離進んだら反転
    if (this.direction === 1 && pos.z >= this.startPos.z + this.data.distance) {
  this.direction = -1;
  this.el.setAttribute('animation', {
    property: 'rotation',
    to: '0 180 0',
    dur: 1500,
    easing: 'easeInOutQuad'
  });
}
else if (this.direction === -1 && pos.z <= this.startPos.z) {
  this.direction = 1;
  this.el.setAttribute('animation', {
    property: 'rotation',
    to: '0 0 0',
    dur: 1500,
    easing: 'easeInOutQuad'
  });
}

  }
});
</script>









     <a-scene physics fog="type: linear; color: #001d3d; near: 10; far: 50">
      <a-asset-item id="ctl_obj"
				src="https://cdn.glitch.com/8091c095-dd99-4d26-9a32-d18db4b80561%2Foculus-touch-controller-right.obj?v=1605781569827">
			</a-asset-item>
			<a-asset-item id="ctl_mtl"
				src="https://cdn.glitch.com/8091c095-dd99-4d26-9a32-d18db4b80561%2Foculus-touch-controller-right.mtl?v=1605781569345">
			</a-asset-item>
        <a-assets>
                <!--3Dモデルの定義（Blenderなどで作成-->
               
                <a-asset-item id="box" src="box.glb"></a-asset-item>
                <a-asset-item id="kumanomi" src="クマノミnew.glb" ></a-asset-item>
                <a-asset-item id="syachi_1" src="syachi.glb" ></a-asset-item>
                <a-asset-item id="ei" src="ei.glb" ></a-asset-item>
                 <a-asset-item id="same" src="サメ_1.glb" ></a-asset-item>
                 <a-asset-item id="angel" src="NewAngelFish1.glb" ></a-asset-item>
                 <a-asset-item id ="kurage" src="クラゲ.glb"></a-asset-item>
                <a-asset-item id ="iwa" src="iwa4.glb"></a-asset-item>
                <a-asset-item id ="kaisou" src="kaisou.glb"></a-asset-item>
                <a-asset-item id="same_2" src="サメ1.glb" ></a-asset-item>
                <a-asset-item id="syachi_2" src="new_syachi.glb" ></a-asset-item>
         </a-assets>
          
           <a-entity
                gltf-model="#box" position="0 -1 0" shadow="receive:true"  
           ></a-entity>
         

            
           </a-entity>
<!-- 前面 -->
<!-- 前面の壁 -->
<a-plane position="1.5 3 -15.05"   
         width="35.1" height="6.1"
         rotation="0 0 0"
         color="#88c"
         material="transparent:true; opacity:0.5; depthTest:false">
</a-plane>

<!-- 背面の壁（奥） -->
<a-plane position="1.5 3 5.05"     
         width="35.1" height="6.1"
         rotation="0 180 0"
         color="#88c"
         material="transparent:true; opacity:0.5; depthTest:false">
</a-plane>

<!-- 左の壁 -->
<a-plane position="-16.05 3 -5"    
         width="20.1" height="6.1"
         rotation="0 90 0"
         color="#88c"
         material="transparent:true; opacity:0.5; depthTest:false">
</a-plane>

<!-- 右の壁 -->
<a-plane position="19.05 3 -5"     
         width="20.1" height="6.1"
         rotation="0 -90 0"
         color="#88c"
         material="transparent:true; opacity:0.5; depthTest:false">
</a-plane>
<a-box position="1.5 6.075 -5" width="35.1" height="0.05" depth="20.1" color="#88c" opacity="0.05" transparent="true" depthWrite:false></a-box>



          <a-entity gltf-model="#ei" position="-40 8 30" shadow="receive:true" scale="0.5 0.5 0.5" animation-mixer no-cull
          ></a-entity>
          <a-entity  gltf-model="#ei" position="20  12 40" rotation ="180 -90 180" shadow="receive:true" scale="0.5 0.5 0.5" animation-mixer no-cull
          ></a-entity>
          
           </a-entity>
          <a-entity
                gltf-model="#syachi_1" no-cull position="0 20 -13" rotation="0 90 0" shadow="receive:true" animation-mixer scale="5 5 5"
           ></a-entity>

            <a-entity
                gltf-model="#syachi_2" no-cull position="30 20 40" rotation="180 90 180" shadow="receive:true" animation-mixer scale="5 5 5"
           ></a-entity>
           
          <a-entity
           gltf-model="#same" no-cull position="10 15 30"   shadow="receive:true" animation-mixer
           ></a-entity>
           <a-entity
           gltf-model="#same" no-cull position="5 20 -20"   shadow="receive:true" animation-mixer
           ></a-entity>
           <a-entity
           gltf-model="#same_2" no-cull position="-10 20 10" rotation="0 90 0"  shadow="receive:true" animation-mixer
           ></a-entity>
           <a-entity
           gltf-model="#iwa"  position="40 0 0" shadow="receive:true" 
           ></a-entity>
           >
         <a-entity spawn-custom></a-entity>
 <!--movement-controls-->
      <a-entity id="rig" position="0 0 0" unified-move-limited="speed: 5; minX: -16; maxX: 19; minZ: -15; maxZ: 5">
  <a-entity camera look-controls="pointerLockEnabled:true; mouseSensitivity:0.6"  position="0 1.6 0"></a-entity>
  <a-entity id="ctl" laser-controls="hand: right" obj-model="obj: #ctl_obj; mtl: #ctl_mtl"></a-entity>
</a-entity>
           <a-sky color="#003388">

           </a-sky>
        </a-scene>
            
    </body>
</html>